name: ðŸŽ¯ ECNTV - Auto Validation

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
  push:
    paths:
      - 'src/**'
      - 'Cargo.toml'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸŽ¯ Checkout ECNTV Repository"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Setup Rust"
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: "ðŸ”¨ Build ECNTV Validator"
        run: |
          echo "ðŸ”¨ Building ECNTV Order-Preserving Validator..."
          cargo build --release --verbose
          echo "âœ… Build completed!"
          ls -lh target/release/ecntv-validator

      - name: "ðŸš€ Run ECNTV Validation"
        run: |
          echo "ðŸš€ Starting ECNTV Multi-Playlist Validation"
          echo "==========================================="
          echo "ðŸ• Started: $(date -u '+%Y-%m-%d %H:%M UTC')"
          echo "ðŸ’» Runner: ${{ runner.os }}"
          echo "ðŸ”¢ CPU Cores: $(nproc)"
          echo "ðŸ”’ Order Preservation: ENABLED"
          echo "==========================================="
          
          # Run the validator
          ./target/release/ecntv-validator
          
          echo "==========================================="
          echo "ðŸ Validation process completed"
          echo "ðŸ• Finished: $(date -u '+%Y-%m-%d %H:%M UTC')"

      - name: "ðŸ“Š Display Results"
        run: |
          echo "ðŸ“ˆ ECNTV VALIDATION RESULTS"
          echo "==========================="
          if [ -f "ECNTV_Validated_Playlist.m3u" ]; then
            TOTAL_STREAMS=$(grep -c "^http" ECNTV_Validated_Playlist.m3u || true)
            TOTAL_METADATA=$(grep -c "^#EXTINF" ECNTV_Validated_Playlist.m3u || true)
            FILE_SIZE=$(stat -c%s "ECNTV_Validated_Playlist.m3u")
            echo "âœ… Valid Streams: $TOTAL_STREAMS"
            echo "ðŸ“º Channel Entries: $TOTAL_METADATA"
            echo "ðŸ’¾ File Size: $(numfmt --to=iec $FILE_SIZE)"
            echo "ðŸ”’ Order Preservation: âœ… Active"
            echo ""
            echo "ðŸŽ¬ Sample Channels (in original order):"
            grep -A1 "^#EXTINF" ECNTV_Validated_Playlist.m3u | head -8 | while read line; do
              if [[ "$line" == *"#EXTINF"* ]]; then
                CHANNEL=$(echo "$line" | sed -n 's/.*,\(.*\)/\1/p')
                echo "   ðŸ“º $CHANNEL"
              fi
            done
          else
            echo "âŒ Error: Output file not found!"
            exit 1
          fi

      - name: "ðŸ’¾ Commit ECNTV Playlist"
        run: |
          echo "ðŸ”§ Configuring Git..."
          git config --local user.email "ecntv@github.com"
          git config --local user.name "ECNTV Bot"
          
          echo "ðŸ“¦ Staging ECNTV playlist..."
          git add ECNTV_Validated_Playlist.m3u
          
          if ! git diff --staged --quiet; then
            echo "ðŸ’¾ Committing updates..."
            git commit -m "ðŸŽ¯ ECNTV Auto-Update [$(date -u '+%Y-%m-%d %H:%M UTC')] - Order Preserved"
            
            echo "ðŸ“¤ Pushing to repository..."
            git push
            echo "âœ… ECNTV playlist updated successfully!"
          else
            echo "â„¹ï¸  No changes - ECNTV playlist is current"
          fi

      - name: "ðŸ“ Upload ECNTV Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: ecntv-playlist
          path: ECNTV_Validated_Playlist.m3u
          retention-days: 7

      - name: "ðŸ“ Create ECNTV Summary"
        run: |
          echo "## ðŸŽ¯ ECNTV Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**â° Last Updated:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ”’ Order Preservation:** âœ… Enabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "ECNTV_Validated_Playlist.m3u" ]; then
            TOTAL_STREAMS=$(grep -c "^http" ECNTV_Validated_Playlist.m3u || true)
            echo "**âœ… Valid Streams:** $TOTAL_STREAMS" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ“ File:** \`ECNTV_Validated_Playlist.m3u\`" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ”§ Status:** ðŸŸ¢ Operational" >> $GITHUB_STEP_SUMMARY
          else
            echo "**ðŸ”§ Status:** ðŸ”´ Validation Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš« Active Filters:" >> $GITHUB_STEP_SUMMARY
          echo "- Adult content removal" >> $GITHUB_STEP_SUMMARY  
          echo "- cinehub24.com blocking" >> $GITHUB_STEP_SUMMARY
          echo "- .mp4 format exclusion" >> $GITHUB_STEP_SUMMARY
          echo "- Original order preservation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Automated by ECNTV Validator*" >> $GITHUB_STEP_SUMMARY